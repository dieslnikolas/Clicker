{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "sftpContainerGroupName": {
            "type": "string",
            "defaultValue": "jobka-containers-test2",
            "metadata": {
                "description": "Container group name"
            }
        },
        "sftpContainerName": {
            "type": "string",
            "defaultValue": "jobka-sftp-test2",
            "metadata" : {
                "description": "Container name in the container group"
            }
        },
        "containerGroupDNSLabel": {
            "type": "string",
            "defaultValue": "jobka-sftp-test2",
            "metadata" : {
                "description": "DNS label for container group. Generated name would be: uniqueString(resourceGroup().id, deployment().name)"
            }
        },
        "existingStorageAccountResourceGroupName": {
            "type": "string",
            "defaultValue": "JobkaTest",
            "metadata": {
                "description": "Resource group for existing storage account"
            }
        },
        "existingStorageAccountName": {
            "type": "string",
            "defaultValue": "jobkatest",
            "metadata": {
                "description": "Name of existing storage account"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Primary location for resources"
            }
        }
    },
    "variables": {
		"sftpUser0": "jobkatest",
		"sftpPassword0": "skelesftp",
		"existingFileShareName0": "sftp-jobkatest",

		"sftpUser1": "kseuropetest",
		"sftpPassword1": "skelesftp",
		"existingFileShareName1": "sftp-kseuropetest",

		"sftpUser2": "msazure",
		"sftpPassword2": "skelesftp",
		"existingFileShareName2": "sftp-testmsazure",

		"sftpUser3": "bedpic",
		"sftpPassword3": "skelesftp",
		"existingFileShareName3": "sftp-bedpic",

		"sftpUser4": "jobkatest2",
		"sftpPassword4": "skelesftp",
		"existingFileShareName4": "sftp-jobkatest",

		"sftpUser5": "kseuropetest2",
		"sftpPassword5": "skelesftp",
		"existingFileShareName5": "sftp-kseuropetest",

		"sftpUser6": "msazure2",
		"sftpPassword6": "skelesftp",
		"existingFileShareName6": "sftp-testmsazure",

		"sftpUser7": "bedpic2",
		"sftpPassword7": "skelesftp",
		"existingFileShareName7": "sftp-bedpic",

		"sftpUser8": "jobkatest3",
		"sftpPassword8": "skelesftp",
		"existingFileShareName8": "sftp-jobkatest",

		"sftpUser9": "kseuropetest3",
		"sftpPassword9": "skelesftp",
		"existingFileShareName9": "sftp-kseuropetest",

		"sftpUser10": "msazure3",
		"sftpPassword10": "skelesftp",
		"existingFileShareName10": "sftp-testmsazure",

		"sftpUser11": "bedpic3",
		"sftpPassword11": "skelesftp",
		"existingFileShareName11": "sftp-bedpic",

		"sftpEnvVariable": "[concat(variables('sftpUser0'), ':', variables('sftpPassword0'), ':::upload ', variables('sftpUser1'), ':', variables('sftpPassword1'), ':::upload ', variables('sftpUser2'), ':', variables('sftpPassword2'), ':::upload ', variables('sftpUser3'), ':', variables('sftpPassword3'), ':::upload ', variables('sftpUser4'), ':', variables('sftpPassword4'), ':::upload ', variables('sftpUser5'), ':', variables('sftpPassword5'), ':::upload ', variables('sftpUser6'), ':', variables('sftpPassword6'), ':::upload ', variables('sftpUser7'), ':', variables('sftpPassword7'), ':::upload ', variables('sftpUser8'), ':', variables('sftpPassword8'), ':::upload ', variables('sftpUser9'), ':', variables('sftpPassword9'), ':::upload ', variables('sftpUser10'), ':', variables('sftpPassword10'), ':::upload ', variables('sftpUser11'), ':', variables('sftpPassword11'), ':::upload ')]",
        "sftpContainerName": "[parameters('sftpContainerName')]",
        "sftpContainerGroupName": "[parameters('sftpContainerGroupName')]",
        "sftpContainerImage": "atmoz/sftp:latest",
        "storageAccountId": "[resourceId(parameters('existingStorageAccountResourceGroupName'), 'Microsoft.Storage/storageAccounts', parameters('existingStorageAccountName'))]"
	},
  "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "name": "pid-18f281fe-d1e1-502c-8b87-d945383dc75b",
            "apiVersion": "2018-05-01",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.ContainerInstance/containerGroups",
            "name": "[variables('sftpContainerGroupName')]",
            "apiVersion": "2018-10-01",
            "location": "[parameters('location')]",
            "properties": {
                "containers": [
                    {
                        "name": "[variables('sftpContainerName')]",
                        "properties": {
                            "image": "[variables('sftpContainerImage')]",
                            "environmentVariables": [
                                {
                                    "name": "SFTP_USERS",
                                    "secureValue": "[variables('sftpEnvVariable')]"
                                }
                            ],
                            "resources": {
                                "requests": {
                                    "cpu": 1,
                                    "memoryInGB": 0.5
                                }
                            },
                            "ports": [
                                {
                                    "port": 22
                                }
                            ],
                            "volumeMounts": [
								{
									"mountPath": "[concat('/home/', variables('sftpUser0'), '/upload')]",
									"name": "sftpvolume0",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser1'), '/upload')]",
									"name": "sftpvolume1",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser2'), '/upload')]",
									"name": "sftpvolume2",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser3'), '/upload')]",
									"name": "sftpvolume3",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser4'), '/upload')]",
									"name": "sftpvolume4",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser5'), '/upload')]",
									"name": "sftpvolume5",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser6'), '/upload')]",
									"name": "sftpvolume6",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser7'), '/upload')]",
									"name": "sftpvolume7",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser8'), '/upload')]",
									"name": "sftpvolume8",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser9'), '/upload')]",
									"name": "sftpvolume9",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser10'), '/upload')]",
									"name": "sftpvolume10",
									"readOnly": false
								},
								{
									"mountPath": "[concat('/home/', variables('sftpUser11'), '/upload')]",
									"name": "sftpvolume11",
									"readOnly": false
								}
							]
                        }
                    }
                ],
                "osType": "Linux",
                "ipAddress": {
                    "type": "Public",
                    "ports": [
                        {
                            "protocol": "TCP",
                            "port": 22
                        }
                    ],
                    "dnsNameLabel": "[parameters('containerGroupDNSLabel')]"
                },
                "restartPolicy": "OnFailure",
                "volumes": [
					{
						"name": "sftpvolume0",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName0')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume1",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName1')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume2",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName2')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume3",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName3')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume4",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName4')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume5",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName5')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume6",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName6')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume7",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName7')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume8",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName8')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume9",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName9')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume10",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName10')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					},
					{
						"name": "sftpvolume11",
						"azureFile": {
                            "readOnly": false,
                            "shareName": "[variables('existingFileShareName11')]",
                            "storageAccountName": "[parameters('existingStorageAccountName')]",
                            "storageAccountKey": "[listKeys(variables('storageAccountId'),'2018-02-01').keys[0].value]"
            			}
					}
				]
            }
        }
    ],
    "outputs": {
        "containerIPv4Address": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups/', variables('sftpContainerGroupName'))).ipAddress.ip]"
        },
        "containerDNSLabel": {
            "type": "string",
            "value": "[concat(parameters('containerGroupDNSLabel'), '.', parameters('location'), '.azurecontainer.io')]"
        }
    }
}